Unit 20 - Sentinel downloader
=============================

There are plenty of libraries or tools which allow downloading
Sentinel products.

For GRASS there are the :grasscmdaddons:`i.sentinel` toolbox. It
consists of six GRASS addon tools:

* :grasscmdaddons:`i.sentinel.coverage`
* :grasscmdaddons:`i.sentinel.download`
* :grasscmdaddons:`i.sentinel.parallel.download`  
* :grasscmdaddons:`i.sentinel.import`
* :grasscmdaddons:`i.sentinel.preproc`
* :grasscmdaddons:`i.sentinel.mask`

The addon can be installed by :grasscmd:`g.extension` or from the main menu
:menuselection:`Settings --> Addons extensions --> Install extension
from addons`.

.. code-block:: bash

   g.extension extension=i.sentinel

.. figure:: ../images/units/20/g-extension.png

   Install :grasscmdaddons:`i.sentinel` GRASS Addon.

.. note:: Note that :grasscmdaddons:`i.sentinel.download` requires
   :grasscmdaddons:`i.eodag` and also `eodag
   <https://pypi.org/project/eodag/>`__ package to be installed. It
   can be easily installed from the :item:`Console` tab by entering
   the command below.
	
   .. code-block:: bash

      g.extension extension=i.eodag                   
      python3 -m pip install eodag

:ref:`Switch <switch-project>` to `jena-region` project which was created in :doc:`02`.

Download data
-------------

Let's download suitable Sentinel products for our area of interest
(AOI) and perform the NDVI calculation as described in :doc:`05`
(implemented as a model in :doc:`08` or as a Python script in
:doc:`11`). AOI region is defined by Jena city region created in
:doc:`03`. `Sentinel-2 L2A products
<https://sentinels.copernicus.eu/sentinel-data-access/sentinel-products/sentinel-2-data-products/collection-1-level-2a>`__
will be used to avoid computing atmospheric corrections.

.. important:: Pre-downloaded Sentinel scenes are available in the
   sample dataset (directory :file:`sentinel/2019`). You may continue
   with :ref:`importing sample data <sentinel-import>` section.

Let's search for the latest available product by means of
:grasscmdaddons:`i.sentinel.download`. Setting the :param:`-l` flag, the result will only
be printed. The download procedure will be performed later. In order to
search and download Sentinel products from the Copernicus Data Space Ecosystem, 
you have to create an account first. See the manual page of
:grasscmdaddons:`i.sentinel.download` tool for details. Create a new text
file :file:`sentinel.txt` containing two lines (username and
password).

.. note::
   To get username and password you need to register at the 
   `Copernicus Data Space Ecosystem <https://dataspace.copernicus.eu/>`__,
   see `Create a new account <https://identity.dataspace.copernicus.eu/auth/realms/CDSE/login-actions/registration?client_id=account-console&tab_id=RPclMHTeCMQ>`__
   page for signing up.

.. code-block:: bash

   i.sentinel.download -l map=jena_boundary producttype=S2MSI2A settings=sentinel.txt

::

   14 scene(s) found.
   S2C_MSIL2A_20260120T102341_N0511_R065_T32UPB_20260120T135514 2026-01-20T10:23:41   0% S2MSI2A size_NA  
   S2B_MSIL2A_20251226T102339_N0511_R065_T32UPB_20251226T124209 2025-12-26T10:23:39  71% S2MSI2A size_NA  
   S2A_MSIL2A_20251213T102441_N0511_R065_T32UPB_20251213T114209 2025-12-13T10:24:41  75% S2MSI2A size_NA  
   ...

By default the tool returns scenes for the last 60 days. Let's
change the search period setting :param:`start` and :param:`end`
options. To be sure that our AOI is fully covered by a Sentinel
product we also set :param:`area_relation` option.  We will also limit
scenes by :param:`clouds` coverage percentage threshold
       
.. code-block:: bash
                
   i.sentinel.download -l map=jena_boundary producttype=S2MSI2A settings=sentinel.txt \
   start=2025-04-01 end=2025-10-01 area_relation=Contains clouds=10

::

   7 scene(s) found.
   S2A_MSIL2A_20250427T101701_N0511_R065_T32UPB_20250427T170513 2025-04-27T10:17:01   0% S2MSI2A size_NA  
   S2C_MSIL2A_20250813T102041_N0511_R065_T32UPB_20250813T160110 2025-08-13T10:20:41   0% S2MSI2A size_NA  
   S2C_MSIL2A_20250614T101621_N0511_R065_T32UPB_20250614T142405 2025-06-14T10:16:21   2% S2MSI2A size_NA  
   ...

..
   .. tip:: If more scenes have been found you can limit search by
   :param:`limit` option.

Let's download the desired scene(s). Just remove the :param:`-l` flag and
add the :param:`output` option in order to define the path to the output directory
where data should be saved.

.. code-block:: bash

   i.sentinel.download map=jena_boundary producttype=S2MSI2A settings=sentinel.txt \
   start=2025-04-01 end=2025-10-01 area_relation=Contains clouds=10 \
   limit=1 output=geodata/sentinel/2025

.. note:: Note all scenes are NOT available online. In this case the
   tool fails, try to download affected scene in the next days.

Import data
-----------

.. _sentinel-import:


Before importing or linking Sentinel data try to print a list of
filtered raster files including projection match (second column, 1 for
match otherwise 0). If the CRS of input data differs from the current project
consider reprojection (:param:`-r`) or creating a new project for
import.

Data will be imported into the GRASS project by means of the
:grasscmdaddons:`i.sentinel.import` tool. The command will import
**all** Sentinel bands from :param:`input` directory
recursively. Before importing data let's check content of the input
directory by :param:`-p` flag. The import procedure will be limited to
the 4th and 8th bands in 10m spatial resolution by :param:`pattern`
option.

.. code-block:: bash
 
   i.sentinel.import -p input=geodata/sentinel/2019 pattern="20190626T102031_B0[4|8]_10m"

::

   ...L2A_T32UPB_A020940_20190626T102028/IMG_DATA/R10m/T32UPB_20190626T102031_B08_10m.jp2 1 (EPSG: 32632)
   ...L2A_T32UPB_A020940_20190626T102028/IMG_DATA/R10m/T32UPB_20190626T102031_B04_10m.jp2 1 (EPSG: 32632)


By default, input data are imported into GRASS data format.
Alternatively, data can be linked if :param:`-l` is given. It is also
useful to import cloud mask vector features by :param:`-c` flag. 

.. code-block:: bash

   i.sentinel.import -l -c input=geodata/sentinel/2019 pattern="20190626T102031_B0[4|8]_10m"

.. note:: Cloud mask is computed by
   :grasscmdaddons:`i.sentinel.import`, the tool doesn't use cloud
   mask product stored in a SAFE directory.
          
Now launch the NDVI sample script created in :doc:`12` (`ndvi-v4.py
<../_static/scripts/ndvi-v4.py>`__) in order to compute NDVI classes
(see processing workflow described in :doc:`09`).
   
.. figure:: ../images/units/20/run-script.png
        
   Run script to compute NDVI classes.

.. figure:: ../images/units/20/ndvi-classes.png
   :class: large
        
   Computed NDVI classes for given AOI.
