Unit 24 - MODIS
===============

The **Moderate Resolution Imaging Spectroradiometer**
(:wikipedia:`MODIS`) is a 36-channel from visible to thermal-infrared
sensor that was launched as part of the Terra satellite payload in
December 1999 and Aqua satellite in May 2002. The Terra satellite
passes twice a day (at 10:30am and 22:30pm local time), the Aqua
satellite also passes twice a day (at 01:30am and 13:30pm local
time). (source: `GRASS Wiki
<https://grasswiki.osgeo.org/wiki/MODIS>`__)

Our area of interest, Germany, is covered by two MODIS tiles (see
`MODLAND grid
<https://modis-land.gsfc.nasa.gov/MODLAND_grid.html>`__):

* h18v03
* h18v04

MODIS data is provided in 3 projections (Sinusoidal, Lambert Azimuthal
Equal-Area, and Geographic). For our purpose, data will be reprojected
to ETRS89 / LAEA Europe :epsg:`3035`.

.. _create-location-epsg:

Create a new GRASS location *germany-modis* (see :ref:`Unit 02
<create-location>`) using EPSG code (*Select CRS from a list by EPSG
or description*).

.. figure:: ../images/units/24/create-location-epsg-0.png

   Create a new location based on EPSG code.

.. figure:: ../images/units/24/create-location-epsg-1.png

   Enter EPSG code.

Enter a new GRASS session (PERMANENT mapset) and install
:grasscmdaddons:`i.modis` addons extension (more about installing
addons in :ref:`Unit 17 <grass-addons>`) for downloading and importing
MODIS data (note that you have to install also `pyMODIS Python Library
<http://www.pymodis.org/>`__). Run two commands below in
:item:`Console` tab.

.. code-block:: bash

   python3 -m pip install setuptools slugify pymodis
   
   g.extension extension=i.modis

GRASS MODIS addon consists of two modules:

* :grasscmdaddons:`i.modis.download` and
* :grasscmdaddons:`i.modis.import`

Download data
-------------

.. important:: Pre-downloaded MODIS data (year 2023) is available in the
   sample dataset (:file:`modis` directory). Readers can continue with
   :ref:`importing sample data <modis-import>`.

Let's download desired tiles (h18v03 and h18v04) for year 2023 by
:grasscmdaddons:`i.modis.download`. 
  
Land Surface Temperature eight day 1 Km (Terra/Aqua) product will be
downloaded.

.. code-block:: bash

   i.modis.download settings=settings.txt folder=modis \
   tiles=h18v03,h18v04 \
   product=lst_aqua_eight_1000,lst_terra_eight_1000 \
   startday=2023-01-01 endday=2023-12-31

.. note:: Output folder (:file:`h18v03_04` in this case) must exists,
   otherwise the module will fail.
             
   File :file:`settings.txt` contains two lines: *username* and
   *password* for accessing MODIS download service.

   Please read `pyModis documentation
   <http://www.pymodis.org/info.html#user-and-password>`__ how to
   register and set up your account.

.. _modis-import:

Import data
-----------
          
Input MODIS data can be imported and reprojected into target location
by :grasscmdaddons:`i.modis.import`.

.. code-block:: bash

   i.modis.import -mw files=modis/listfileMOD11A2.061.txt \
   spectral='( 1 0 0 0 1 0 0 0 0 0 0 0 )' outfile=tlist-mod.txt

   i.modis.import -mw files=modis/listfileMYD11A2.061.txt \
   spectral='( 1 0 0 0 1 0 0 0 0 0 0 0 )' outfile=tlist-myd.txt

If ``-m`` flag is given mosaic from input tiles is created
automatically, see :numref:`modis-mosaics`.

.. note:: See relevant `source code
   <https://github.com/OSGeo/grass-addons/blob/grass8/src/imagery/i.modis/libmodis/rmodislib.py#L78>`__
   related to :option:`spectral` option.
          
.. _modis-mosaics:

.. figure:: ../images/units/24/modis-mosaics.png
   :class: large
        
   Data mosaic created from h18v03 and h18v04 tiles.

Germany administrative border
-----------------------------

Germany administrative border can created by dissolving
:map:`counties` used in :doc:`14`. First copy the vector map
:map:`counties` from `jena-region` GRASS location to the current
mapset and location (see :ref:`Unit 15 <data-reproject-fig>`).

Next, open the attribute table |grass-table| :sup:`Show attribute data
for selected vector map` and add a new column used for dissolving.

.. figure:: ../images/units/24/counties-add-column.png

   Add a new column 'value'.

.. figure:: ../images/units/24/counties-fill-column-0.png
   :class: middle
           
   Open Field calculator.

.. figure:: ../images/units/24/counties-fill-column-1.png
   :class: middle
           
   Fill new column by value of 1.

.. tip:: Steps described above may me performed from command line by
   :grasscmd:`v.db.addcolumn` and :grasscmd:`v.db.update`.

   .. code-block:: bash

      v.db.addcolumn map=counties columns="value int"
      v.db.update map=counties column=value value=1
             
Now, we can perform dissolving all counties by :grasscmd:`v.dissolve`:

.. code-block:: bash

   v.dissolve input=counties output=germany column=value
     
.. _modis-lst:
   
LST
---

In this section **Land Surface Temperature** (LST) analysis will be
perfmored for Germany. 

Mask will be created by :grasscmd:`r.mask`. Don't forget that
computational region must be set before creating a mask. Computational
region will be defined by Germany vector map and aligned by the input
MODIS data by :grasscmd:`g.region`.

.. code-block:: bash

   g.region vector=germany align=MOD11A2.A2023001_mosaic_LST_Day_1km
   r.mask vector=germany

Let's check range values of imported MODIS data by :grasscmd:`r.info` module:

.. code-block:: bash

   r.info -r map=MOD11A2.A2023001_mosaic_LST_Day_1km

::

   min=0
   max=14511

.. _modis-dn-c:
  
In order to determine LST from input data, digital values (DN) must be
converted into Celsius or Kelvin scale.

.. math::

   C = DN * 0.02 - 273.15

Conversion to Celsium scale can be done by :grasscmd:`r.mapcalc` (see
also :doc:`05`). It's also suitable to replace zero values with
no-data value (NULL value in GRASS terminology).

.. code-block:: bash
                
   r.mapcalc expression="MOD11A2.A2023001_mosaic_LST_Day_1km_c = \
   if(MOD11A2.A2023001_mosaic_LST_Day_1km != 0, \
   MOD11A2.A2023001_mosaic_LST_Day_1km * 0.02 - 273.15, null())"

Let's check range values of new LST data layer.

.. code-block:: bash

   r.info -r map=MOD11A2.A2023001_mosaic_LST_Day_1km_c

::

   min=-22.21
   max=12.09

.. figure:: ../images/units/24/lst-c.png
   :class: large
        
   LST reconstruction for Germany in Celsius scale (color table
   ``celsius`` applied).
